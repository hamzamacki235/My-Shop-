<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gear Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet" />
  <style>
    /* ---------- ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… ---------- */
    body {
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      direction: rtl;
      color: #333;
      transition: background-color 0.5s ease, color 0.5s ease;
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
    }
    .header {
      background: linear-gradient(to right, #2980b9, #6dd5fa);
      padding: 15px 20px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .topnav {
      background: linear-gradient(to right, #34495e, #2c3e50);
      color: #fff;
      padding: 12px 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .topnav a {
      color: #fff;
      text-decoration: none;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .main-section {
      padding: 30px;
    }
    .product {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
      text-align: center;
      margin-bottom: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .product:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    button {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      opacity: .85;
      transform: scale(1.03);
      transition: all .2s ease-in-out;
    }
    .dark-mode {
      background: #121212;
      color: #f1f1f1;
    }
    .dark-mode .product,
    .dark-mode form {
      background: #1e1e1e;
      color: #f1f1f1;
      border-color: #333;
    }
    form {
      max-width: 400px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
    }
    form input, form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #product-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }
    #cart-list .product {
      text-align: right;
    }
    .badge {
      background: #dc3545;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      margin-right: 5px;
      display: none;
    }

    /* ---------- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ---------- */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,.5);
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .modal-content {
      background: #fff;
      padding: 30px 25px;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,.3);
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      animation: modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .close-modal {
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
    }
    .modal-content input {
      width: 100%;
      padding: 10px 12px;
      margin: 12px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .modal-content button {
      width: 100%;
      padding: 12px;
      background: #2980b9;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color .3s ease;
    }
    .modal-content button:hover {
      background: #1c5980;
    }
    .social-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 6px 0;
      font-size: 15px;
      padding: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .google-btn {
      background: #fff;
      color: #444;
      border: 1px solid #ddd;
    }
    .fb-btn {
      background: #1877f2;
      color: #fff;
    }

    /* ---------- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ ---------- */
    @media (max-width: 768px) {
      .header {
        padding: 15px;
        text-align: center;
        flex-direction: column;
      }
      
      .header h1 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      
      .topnav {
        flex-direction: column;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: unset;
        padding: 5px;
        gap: 5px;
        z-index: 1000;
        display: none;
      }
      
      .topnav.show {
        display: flex;
      }
      
      .topnav a {
        padding: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .nav-text {
        display: none;
      }
      
      .mobile-menu-btn {
        position: fixed;
        bottom: 15px;
        right: 15px;
        background: #2980b9;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 1001;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
      
      #product-list {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .product {
        padding: 10px;
      }
      
      .modal-content {
        width: 90%;
        padding: 15px;
      }
      
      .main-section {
        padding: 15px;
        margin-bottom: 60px;
      }
      
      .social-btn {
        font-size: 0.8rem;
        padding: 8px;
      }
      
      /* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
      .search-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .search-container input {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      #product-list {
        grid-template-columns: 1fr;
      }
    }

    /* ---------- Ù…ÙŠØ²Ø© Ø§Ù„Ø¨Ø­Ø« ---------- */
    .search-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      gap: 10px;
    }
    
    .search-container input {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 300px;
      max-width: 100%;
    }
    
    /* ---------- Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ---------- */
    .rating {
      direction: ltr;
      unicode-bidi: bidi-override;
      margin: 10px 0;
    }
    
    .rating input {
      display: none;
    }
    
    .rating label {
      color: #ddd;
      font-size: 24px;
      padding: 0 3px;
      cursor: pointer;
    }
    
    .rating label:hover,
    .rating label:hover ~ label,
    .rating input:checked ~ label {
      color: #ffc107;
    }
    
    .average-rating {
      font-size: 16px;
      margin-top: 5px;
      color: #ffc107;
    }
    
    /* ---------- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---------- */
    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ---------- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---------- */
    footer {
      text-align: center;
      padding: 20px;
      background: #f0f0f0;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <!-- ---------- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ---------- -->
  <div class="header">
    <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…ØªØ¬Ø± Gear Store</h1>
    <button onclick="toggleDarkMode()">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
  </div>

  <!-- ---------- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ ---------- -->
  <div class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</div>
  <div class="topnav" id="navbar-links">
    <a href="#index" class="nav-icon">ğŸ <span class="nav-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
    <a href="#products" class="nav-icon">ğŸ›’<span class="nav-text">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span></a>
    <a href="#cart" class="nav-icon">ğŸ›ï¸<span class="nav-text">Ø§Ù„Ø¹Ø±Ø¨Ø©</span><span id="cart-badge" class="badge"></span></a>
    <a href="#orders" class="nav-icon">ğŸ“¦<span class="nav-text">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>
    <a href="#add" class="nav-icon">â•<span class="nav-text">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</span></a>
    <div class="auth-links">
      <a href="#" id="loginLink" onclick="openModal('loginModal')">ğŸ”<span class="nav-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></a>
      <a href="#" id="registerLink" onclick="openModal('registerModal')">â•<span class="nav-text">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span></a>
      <a href="#" id="logoutLink" style="display:none" onclick="logoutUser()">ğŸšª<span class="nav-text">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span></a>
    </div>
  </div>

  <!-- ---------- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ---------- -->
  <div class="search-container">
    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="searchProducts()">
    <select id="category-filter" onchange="filterProducts()">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
      <option value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
      <option value="Ù…Ù„Ø§Ø¨Ø³">Ù…Ù„Ø§Ø¨Ø³</option>
      <option value="Ø£Ø«Ø§Ø«">Ø£Ø«Ø§Ø«</option>
    </select>
  </div>

  <!-- ---------- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---------- -->
  <section id="products" class="main-section">
    <h2>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div id="product-list">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
      </div>
    </div>
  </section>

  <section id="cart" class="main-section">
    <h2>Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h2>
    <div id="cart-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨Ø©.</div>
    <button onclick="checkout()">ğŸ’³ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
  </section>

  <section id="orders" class="main-section">
    <h2>Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <div id="order-list">...ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
  </section>

  <!-- ---------- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---------- -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

      <!-- Ø¨Ø±ÙŠØ¯/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± -->
      <form onsubmit="loginUser(event)">
        <input type="email"    id="login-email"    placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
        <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"     required />
        <button type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </form>

      <hr>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø³ÙˆØ´ÙŠØ§Ù„ -->
      <button class="social-btn google-btn" onclick="signInWithGoogle()">ğŸ”‘ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google</button>
      <button class="social-btn fb-btn"     onclick="signInWithFacebook()">ğŸ”‘ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Facebook</button>
    </div>
  </div>

  <!-- ---------- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ---------- -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('registerModal')">&times;</span>
      <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
      <form onsubmit="registerUser(event)">
        <input type="email"    id="register-email"    placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
        <input type="password" id="register-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"     required />
        <button type="submit">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
      </form>
    </div>
  </div>

  <!-- ---------- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ---------- -->
  <div id="ratingModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('ratingModal')">&times;</span>
      <h2>Ù‚ÙŠÙ… Ø§Ù„Ù…Ù†ØªØ¬</h2>
      <form onsubmit="submitRating(event)">
        <input type="hidden" id="rating-product-id">
        <div class="rating">
          <input type="radio" id="star5" name="rating" value="5" /><label for="star5">â˜…</label>
          <input type="radio" id="star4" name="rating" value="4" /><label for="star4">â˜…</label>
          <input type="radio" id="star3" name="rating" value="3" /><label for="star3">â˜…</label>
          <input type="radio" id="star2" name="rating" value="2" /><label for="star2">â˜…</label>
          <input type="radio" id="star1" name="rating" value="1" /><label for="star1">â˜…</label>
        </div>
        <textarea id="rating-comment" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </form>
    </div>
  </div>

  <!-- ---------- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---------- -->
  <footer>
    <p>Â© 2023 Gear Store. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
  </footer>

  <!-- ---------- Ø³ÙƒØ±ÙŠØ¨Øª Firebase ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù ---------- -->
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAnalytics
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      GoogleAuthProvider, FacebookAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, serverTimestamp,
      doc, setDoc, getDoc, updateDoc, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ---- Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ---- */
    const firebaseConfig = {
      apiKey:            "AIzaSyAB7IuZDg99I0NJcTzOicvjtz4Lxg448ms",
      authDomain:        "gearstore-51108.firebaseapp.com",
      projectId:         "gearstore-51108",
      storageBucket:     "gearstore-51108.appspot.com",
      messagingSenderId: "397057376368",
      appId:             "1:397057376368:web:646d75263ed930a3f2b4b5",
      measurementId:     "G-Q16MW55P0W"
    };
    const app      = initializeApp(firebaseConfig);
    const analytics= getAnalytics(app);
    const auth     = getAuth(app);
// âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html"; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ => ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  }
});

    const db       = getFirestore(app);

    /* ---- Ù…Ø²ÙˆØ¯ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---- */
    const googleProvider   = new GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: "select_account" });
    const facebookProvider = new FacebookAuthProvider();

    /* ---- Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¨Ø© ---- */
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");
    let allProducts = [];

    /* ---- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø© ---- */
    function toggleMobileMenu() {
      const nav = document.getElementById('navbar-links');
      nav.classList.toggle('show');
    }

    document.querySelectorAll('.topnav a').forEach(link => {
      link.addEventListener('click', () => {
        document.getElementById('navbar-links').classList.remove('show');
      });
    });

    /* ---- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© ---- */
    function searchProducts() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const filtered = allProducts.filter(product => 
        product.name.toLowerCase().includes(searchTerm) || 
        product.desc.toLowerCase().includes(searchTerm)
      );
      renderProducts(filtered);
    }

    function filterProducts() {
      const category = document.getElementById('category-filter').value;
      if (!category) {
        renderProducts(allProducts);
        return;
      }
      const filtered = allProducts.filter(product => product.category === category);
      renderProducts(filtered);
    }

    function renderProducts(products) {
      const container = document.getElementById("product-list");
      container.innerHTML = "";
      
      if (products.length === 0) {
        container.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</div>';
        return;
      }
      
      products.forEach(product => {
        const card = document.createElement("div");
        card.className = "product";
        
        // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        const avgRating = product.ratings && product.ratings.length > 0 ? 
          (product.ratings.reduce((sum, r) => sum + r.rating, 0) / product.ratings.length).toFixed(1) : 
          0;
        
        card.innerHTML = `
          <img src="${product.image}" style="max-width:100%;border-radius:8px;">
          <h3>${product.name}</h3>
          <p>${product.desc}</p>
          <strong>Ø§Ù„Ø³Ø¹Ø±: ${product.price} Ø±ÙŠØ§Ù„</strong>
          <div class="average-rating">${'â˜…'.repeat(Math.round(avgRating))} (${avgRating})</div>
        `;
        
        const btnCart = document.createElement("button");
        btnCart.textContent = "ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©";
        btnCart.addEventListener("click", () => addToCart(product));
        card.appendChild(btnCart);
        
        const btnRate = document.createElement("button");
        btnRate.textContent = "â­ Ù‚ÙŠÙ… Ø§Ù„Ù…Ù†ØªØ¬";
        btnRate.style.marginTop = "5px";
        btnRate.style.background = "#ffc107";
        btnRate.addEventListener("click", () => openRatingModal(product.id));
        card.appendChild(btnRate);
        
        container.appendChild(card);
      });
    }

    /* ---- ÙˆØ¸ÙŠÙØ© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ---- */
    function openRatingModal(productId) {
      if (!auth.currentUser) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù†ØªØ¬");
        openModal("loginModal");
        return;
      }
      document.getElementById("rating-product-id").value = productId;
      openModal("ratingModal");
    }

    /* ---- ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ---- */
    async function submitRating(e) {
      e.preventDefault();
      const productId = document.getElementById("rating-product-id").value;
      const rating = document.querySelector('input[name="rating"]:checked').value;
      const comment = document.getElementById("rating-comment").value;
      const userId = auth.currentUser.uid;
      
      try {
        const productRef = doc(db, "products", productId);
        await updateDoc(productRef, {
          ratings: arrayUnion({
            userId,
            rating: parseInt(rating),
            comment,
            timestamp: serverTimestamp()
          })
        });
        
        alert("Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø§Ù„Ù…Ù†ØªØ¬!");
        closeModal("ratingModal");
        loadProducts();
      } catch (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: " + error.message);
      }
    }

    /* ---- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¨Ø© ---- */
    function renderCart() {
      const cartContainer = document.getElementById("cart-list");
      cartContainer.innerHTML = cart.length ? "" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨Ø©.";
      cart.forEach((p, index) => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <h3>${p.name}</h3>
          <strong>${p.price} Ø±ÙŠØ§Ù„</strong><br>
          <button onclick="removeFromCart(${index})" style="background:#dc3545">âŒ Ø­Ø°Ù</button>
        `;
        cartContainer.appendChild(div);
      });
      updateCartBadge();
    }

    function updateCartBadge() {
      const badge = document.getElementById("cart-badge");
      if (badge) {
        badge.textContent = cart.length > 0 ? cart.length : "";
        badge.style.display = cart.length > 0 ? "inline-block" : "none";
      }
    }

    window.removeFromCart = function(index) {
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    };

    /* ---- Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ ---- */
    async function checkout() {
      if (!auth.currentUser) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨");
        openModal("loginModal");
        return;
      }
      if (!cart.length) return alert("Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©!");
      
      try {
        await addDoc(collection(db, "orders"), {
          userId: auth.currentUser.uid,
          items: cart,
          createdAt: serverTimestamp(),
          status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"
        });
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
        cart = [];
        localStorage.removeItem("cart");
        renderCart();
        loadOrders();
      } catch (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
      }
    }

    /* ---- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---- */
    async function loadOrders() {
      const container = document.getElementById("order-list");
      container.innerHTML = "";
      if (!auth.currentUser) {
        container.innerHTML = "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.";
        return;
      }
      
      try {
        const querySnapshot = await getDocs(collection(db, "orders"));
        let found = false;
        querySnapshot.forEach(doc => {
          const order = doc.data();
          if (order.userId !== auth.currentUser.uid) return;
          found = true;
          const card = document.createElement("div");
          card.className = "product";
          const dateStr = order.createdAt ? order.createdAt.toDate().toLocaleString() : "ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…ØªÙˆÙØ±";
          card.innerHTML = `<h4>Ø·Ù„Ø¨ Ø¨ØªØ§Ø±ÙŠØ®: ${dateStr} (${order.status})</h4>`;
          order.items.forEach(p => {
            card.innerHTML += `<p>ğŸ“¦ ${p.name} - ${p.price} Ø±ÙŠØ§Ù„</p>`;
          });
          container.appendChild(card);
        });
        if (!found) container.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….";
      } catch (error) {
        container.innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.";
        console.error("Error loading orders:", error);
      }
    }

    /* ---- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---- */
    async function loadProducts() {
      const container = document.getElementById("product-list");
      container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p></div>';
      
      try {
        const querySnapshot = await getDocs(collection(db, "products"));
        allProducts = [];
        querySnapshot.forEach(doc => {
          allProducts.push({ id: doc.id, ...doc.data() });
        });
        
        if (allProducts.length === 0) {
          container.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
          return;
        }
        
        renderProducts(allProducts);
      } catch (error) {
        container.innerHTML = '<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.</div>';
        console.error("Error loading products:", error);
      }
    }

    /* ---- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø¹Ø±Ø¨Ø© ---- */
    window.addToCart = function(product) {
      if (!auth.currentUser) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø©.");
        openModal("loginModal");
        return;
      }
      
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        if (confirm("Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ© Ø£Ø®Ø±Ù‰ØŸ")) {
          cart.push(product);
        }
      } else {
        cart.push(product);
      }
      
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø©");
    };

    /* ---- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ ---- */
    window.loginUser = function(e) {
      e.preventDefault();
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;
      
      if (!email || !password) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
        return;
      }
      
      const btn = e.target.querySelector("button[type='submit']");
      const originalText = btn.textContent;
      btn.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...";
      btn.disabled = true;
      
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
          closeModal("loginModal");
          renderCart();
          loadOrders();
        })
        .catch(err => {
          let message = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
          if (err.code === "auth/invalid-credential") {
            message = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
          }
          alert(message);
        })
        .finally(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        });
    };

    /* ---- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„ ---- */
    window.signInWithGoogle = function() {
      signInWithPopup(auth, googleProvider)
        .then(() => {
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google");
          closeModal("loginModal");
          renderCart();
          loadOrders();
        })
        .catch(err => alert("Ø®Ø·Ø£: " + err.message));
    };

    /* ---- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙÙŠØ³Ø¨ÙˆÙƒ ---- */
    window.signInWithFacebook = function() {
      signInWithPopup(auth, facebookProvider)
        .then(() => {
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Facebook");
          closeModal("loginModal");
          renderCart();
          loadOrders();
        })
        .catch(err => {
          if (err.code === "auth/account-exists-with-different-credential") {
            alert("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ³Ø¬ÙŠÙ„ Ù…Ø®ØªÙ„ÙØ©. Ø¬Ø±Ù‘Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø®Ø±Ù‰.");
          } else {
            alert("Ø®Ø·Ø£: " + err.message);
          }
        });
    };

    /* ---- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ ---- */
    window.registerUser = function(e) {
      e.preventDefault();
      const email = document.getElementById("register-email").value.trim();
      const password = document.getElementById("register-password").value;
      
      if (!email || !password) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
        return;
      }
      
      const btn = e.target.querySelector("button[type='submit']");
      const originalText = btn.textContent;
      btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...";
      btn.disabled = true;
      
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
          closeModal("registerModal");
        })
        .catch(err => alert("Ø®Ø·Ø£: " + err.message))
        .finally(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        });
    };

    /* ---- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ---- */
    window.logoutUser = function() {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        signOut(auth).then(() => {
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
          renderCart();
          loadOrders();
        }).catch(err => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + err.message));
      }
    };

    /* ---- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---- */
    onAuthStateChanged(auth, (user) => {
      const loginLink = document.getElementById("loginLink");
      const registerLink = document.getElementById("registerLink");
      const logoutLink = document.getElementById("logoutLink");
      if (user) {
        loginLink.style.display = "none";
        registerLink.style.display = "none";
        logoutLink.style.display = "inline-block";
      } else {
        loginLink.style.display = "inline-block";
        registerLink.style.display = "inline-block";
        logoutLink.style.display = "none";
      }
    });

    /* ---- ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ ---- */
    window.addEventListener("DOMContentLoaded", () => {
      renderCart();
      loadProducts();
      loadOrders();
    });
  </script>

  <!-- ---------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Ù…ÙˆØ¯Ø§Ù„Ø§ØªØŒ ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ) ---------- -->
  <script>
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    }
    
    function openModal(id) {
      document.getElementById(id).style.display = "flex";
      document.body.style.overflow = "hidden";
    }
    
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
      document.body.style.overflow = "auto";
    }
    
    window.onclick = function(e) {
      ["loginModal", "registerModal", "ratingModal"].forEach(id => {
        const m = document.getElementById(id);
        if (e.target === m) closeModal(id);
      });
    };
    
    // ØªØ­Ù…ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark-mode");
    }
  </script>
</body>
</html>