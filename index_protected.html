<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gear Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet" />
  <style>
    /* ---------- تنسيق عام ---------- */
    body {
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      direction: rtl;
      color: #333;
      transition: background-color 0.5s ease, color 0.5s ease;
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
    }
    .header {
      background: linear-gradient(to right, #2980b9, #6dd5fa);
      padding: 15px 20px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .topnav {
      background: linear-gradient(to right, #34495e, #2c3e50);
      color: #fff;
      padding: 12px 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .topnav a {
      color: #fff;
      text-decoration: none;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .main-section {
      padding: 30px;
    }
    .product {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
      text-align: center;
      margin-bottom: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .product:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    button {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      opacity: .85;
      transform: scale(1.03);
      transition: all .2s ease-in-out;
    }
    .dark-mode {
      background: #121212;
      color: #f1f1f1;
    }
    .dark-mode .product,
    .dark-mode form {
      background: #1e1e1e;
      color: #f1f1f1;
      border-color: #333;
    }
    form {
      max-width: 400px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
    }
    form input, form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #product-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }
    #cart-list .product {
      text-align: right;
    }
    .badge {
      background: #dc3545;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      margin-right: 5px;
      display: none;
    }

    /* ---------- المودالات ---------- */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,.5);
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .modal-content {
      background: #fff;
      padding: 30px 25px;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,.3);
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      animation: modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .close-modal {
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
    }
    .modal-content input {
      width: 100%;
      padding: 10px 12px;
      margin: 12px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .modal-content button {
      width: 100%;
      padding: 12px;
      background: #2980b9;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color .3s ease;
    }
    .modal-content button:hover {
      background: #1c5980;
    }
    .social-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 6px 0;
      font-size: 15px;
      padding: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .google-btn {
      background: #fff;
      color: #444;
      border: 1px solid #ddd;
    }
    .fb-btn {
      background: #1877f2;
      color: #fff;
    }

    /* ---------- تنسيقات الجوال ---------- */
    @media (max-width: 768px) {
      .header {
        padding: 15px;
        text-align: center;
        flex-direction: column;
      }
      
      .header h1 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      
      .topnav {
        flex-direction: column;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: unset;
        padding: 5px;
        gap: 5px;
        z-index: 1000;
        display: none;
      }
      
      .topnav.show {
        display: flex;
      }
      
      .topnav a {
        padding: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .nav-text {
        display: none;
      }
      
      .mobile-menu-btn {
        position: fixed;
        bottom: 15px;
        right: 15px;
        background: #2980b9;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 1001;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
      
      #product-list {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .product {
        padding: 10px;
      }
      
      .modal-content {
        width: 90%;
        padding: 15px;
      }
      
      .main-section {
        padding: 15px;
        margin-bottom: 60px;
      }
      
      .social-btn {
        font-size: 0.8rem;
        padding: 8px;
      }
      
      /* تحسين شريط البحث */
      .search-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .search-container input {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      #product-list {
        grid-template-columns: 1fr;
      }
    }

    /* ---------- ميزة البحث ---------- */
    .search-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      gap: 10px;
    }
    
    .search-container input {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 300px;
      max-width: 100%;
    }
    
    /* ---------- ميزة التقييمات ---------- */
    .rating {
      direction: ltr;
      unicode-bidi: bidi-override;
      margin: 10px 0;
    }
    
    .rating input {
      display: none;
    }
    
    .rating label {
      color: #ddd;
      font-size: 24px;
      padding: 0 3px;
      cursor: pointer;
    }
    
    .rating label:hover,
    .rating label:hover ~ label,
    .rating input:checked ~ label {
      color: #ffc107;
    }
    
    .average-rating {
      font-size: 16px;
      margin-top: 5px;
      color: #ffc107;
    }
    
    /* ---------- مؤشر التحميل ---------- */
    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ---------- تذييل الصفحة ---------- */
    footer {
      text-align: center;
      padding: 20px;
      background: #f0f0f0;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <!-- ---------- رأس الصفحة ---------- -->
  <div class="header">
    <h1>مرحباً بك في متجر Gear Store</h1>
    <button onclick="toggleDarkMode()">🌙 الوضع الليلي</button>
  </div>

  <!-- ---------- شريط التنقل ---------- -->
  <div class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</div>
  <div class="topnav" id="navbar-links">
    <a href="#index" class="nav-icon">🏠<span class="nav-text">الرئيسية</span></a>
    <a href="#products" class="nav-icon">🛒<span class="nav-text">المنتجات</span></a>
    <a href="#cart" class="nav-icon">🛍️<span class="nav-text">العربة</span><span id="cart-badge" class="badge"></span></a>
    <a href="#orders" class="nav-icon">📦<span class="nav-text">الطلبات</span></a>
    <a href="#add" class="nav-icon">➕<span class="nav-text">إضافة منتج</span></a>
    <div class="auth-links">
      <a href="#" id="loginLink" onclick="openModal('loginModal')">🔐<span class="nav-text">تسجيل الدخول</span></a>
      <a href="#" id="registerLink" onclick="openModal('registerModal')">➕<span class="nav-text">حساب جديد</span></a>
      <a href="#" id="logoutLink" style="display:none" onclick="logoutUser()">🚪<span class="nav-text">تسجيل خروج</span></a>
    </div>
  </div>

  <!-- ---------- شريط البحث ---------- -->
  <div class="search-container">
    <input type="text" id="search-input" placeholder="ابحث عن منتج..." oninput="searchProducts()">
    <select id="category-filter" onchange="filterProducts()">
      <option value="">جميع الفئات</option>
      <option value="إلكترونيات">إلكترونيات</option>
      <option value="ملابس">ملابس</option>
      <option value="أثاث">أثاث</option>
    </select>
  </div>

  <!-- ---------- الأقسام الرئيسية ---------- -->
  <section id="products" class="main-section">
    <h2>المنتجات</h2>
    <div id="product-list">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p>جاري تحميل المنتجات...</p>
      </div>
    </div>
  </section>

  <section id="cart" class="main-section">
    <h2>عربة التسوق</h2>
    <div id="cart-list">لا توجد منتجات في العربة.</div>
    <button onclick="checkout()">💳 تأكيد الطلب</button>
  </section>

  <section id="orders" class="main-section">
    <h2>سجل الطلبات</h2>
    <div id="order-list">...تحميل الطلبات</div>
  </section>

  <!-- ---------- مودال تسجيل الدخول ---------- -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
      <h2>تسجيل الدخول</h2>

      <!-- بريد/كلمة مرور -->
      <form onsubmit="loginUser(event)">
        <input type="email"    id="login-email"    placeholder="البريد الإلكتروني" required />
        <input type="password" id="login-password" placeholder="كلمة المرور"     required />
        <button type="submit">تسجيل الدخول</button>
      </form>

      <hr>

      <!-- أزرار سوشيال -->
      <button class="social-btn google-btn" onclick="signInWithGoogle()">🔑 الدخول عبر Google</button>
      <button class="social-btn fb-btn"     onclick="signInWithFacebook()">🔑 الدخول عبر Facebook</button>
    </div>
  </div>

  <!-- ---------- مودال إنشاء حساب ---------- -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('registerModal')">&times;</span>
      <h2>إنشاء حساب جديد</h2>
      <form onsubmit="registerUser(event)">
        <input type="email"    id="register-email"    placeholder="البريد الإلكتروني" required />
        <input type="password" id="register-password" placeholder="كلمة المرور"     required />
        <button type="submit">إنشاء الحساب</button>
      </form>
    </div>
  </div>

  <!-- ---------- مودال التقييم ---------- -->
  <div id="ratingModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('ratingModal')">&times;</span>
      <h2>قيم المنتج</h2>
      <form onsubmit="submitRating(event)">
        <input type="hidden" id="rating-product-id">
        <div class="rating">
          <input type="radio" id="star5" name="rating" value="5" /><label for="star5">★</label>
          <input type="radio" id="star4" name="rating" value="4" /><label for="star4">★</label>
          <input type="radio" id="star3" name="rating" value="3" /><label for="star3">★</label>
          <input type="radio" id="star2" name="rating" value="2" /><label for="star2">★</label>
          <input type="radio" id="star1" name="rating" value="1" /><label for="star1">★</label>
        </div>
        <textarea id="rating-comment" placeholder="اكتب تعليقك (اختياري)"></textarea>
        <button type="submit">إرسال التقييم</button>
      </form>
    </div>
  </div>

  <!-- ---------- تذييل الصفحة ---------- -->
  <footer>
    <p>© 2023 Gear Store. جميع الحقوق محفوظة.</p>
  </footer>

  <!-- ---------- سكريبت Firebase والوظائف ---------- -->
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAnalytics
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      GoogleAuthProvider, FacebookAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, serverTimestamp,
      doc, setDoc, getDoc, updateDoc, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ---- إعداد Firebase ---- */
    const firebaseConfig = {
      apiKey:            "AIzaSyAB7IuZDg99I0NJcTzOicvjtz4Lxg448ms",
      authDomain:        "gearstore-51108.firebaseapp.com",
      projectId:         "gearstore-51108",
      storageBucket:     "gearstore-51108.appspot.com",
      messagingSenderId: "397057376368",
      appId:             "1:397057376368:web:646d75263ed930a3f2b4b5",
      measurementId:     "G-Q16MW55P0W"
    };
    const app      = initializeApp(firebaseConfig);
    const analytics= getAnalytics(app);
    const auth     = getAuth(app);
// ✅ تحقق من حالة تسجيل الدخول
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html"; // المستخدم غير مسجل => تحويل تلقائي
  }
});

    const db       = getFirestore(app);

    /* ---- مزودي تسجيل الدخول ---- */
    const googleProvider   = new GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: "select_account" });
    const facebookProvider = new FacebookAuthProvider();

    /* ---- حالة العربة ---- */
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");
    let allProducts = [];

    /* ---- وظائف القائمة المتنقلة ---- */
    function toggleMobileMenu() {
      const nav = document.getElementById('navbar-links');
      nav.classList.toggle('show');
    }

    document.querySelectorAll('.topnav a').forEach(link => {
      link.addEventListener('click', () => {
        document.getElementById('navbar-links').classList.remove('show');
      });
    });

    /* ---- وظائف البحث والتصفية ---- */
    function searchProducts() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const filtered = allProducts.filter(product => 
        product.name.toLowerCase().includes(searchTerm) || 
        product.desc.toLowerCase().includes(searchTerm)
      );
      renderProducts(filtered);
    }

    function filterProducts() {
      const category = document.getElementById('category-filter').value;
      if (!category) {
        renderProducts(allProducts);
        return;
      }
      const filtered = allProducts.filter(product => product.category === category);
      renderProducts(filtered);
    }

    function renderProducts(products) {
      const container = document.getElementById("product-list");
      container.innerHTML = "";
      
      if (products.length === 0) {
        container.innerHTML = '<div class="empty">لا توجد منتجات مطابقة للبحث</div>';
        return;
      }
      
      products.forEach(product => {
        const card = document.createElement("div");
        card.className = "product";
        
        // حساب متوسط التقييم
        const avgRating = product.ratings && product.ratings.length > 0 ? 
          (product.ratings.reduce((sum, r) => sum + r.rating, 0) / product.ratings.length).toFixed(1) : 
          0;
        
        card.innerHTML = `
          <img src="${product.image}" style="max-width:100%;border-radius:8px;">
          <h3>${product.name}</h3>
          <p>${product.desc}</p>
          <strong>السعر: ${product.price} ريال</strong>
          <div class="average-rating">${'★'.repeat(Math.round(avgRating))} (${avgRating})</div>
        `;
        
        const btnCart = document.createElement("button");
        btnCart.textContent = "🛒 أضف للعربة";
        btnCart.addEventListener("click", () => addToCart(product));
        card.appendChild(btnCart);
        
        const btnRate = document.createElement("button");
        btnRate.textContent = "⭐ قيم المنتج";
        btnRate.style.marginTop = "5px";
        btnRate.style.background = "#ffc107";
        btnRate.addEventListener("click", () => openRatingModal(product.id));
        card.appendChild(btnRate);
        
        container.appendChild(card);
      });
    }

    /* ---- وظيفة فتح مودال التقييم ---- */
    function openRatingModal(productId) {
      if (!auth.currentUser) {
        alert("يرجى تسجيل الدخول لتقييم المنتج");
        openModal("loginModal");
        return;
      }
      document.getElementById("rating-product-id").value = productId;
      openModal("ratingModal");
    }

    /* ---- وظيفة إرسال التقييم ---- */
    async function submitRating(e) {
      e.preventDefault();
      const productId = document.getElementById("rating-product-id").value;
      const rating = document.querySelector('input[name="rating"]:checked').value;
      const comment = document.getElementById("rating-comment").value;
      const userId = auth.currentUser.uid;
      
      try {
        const productRef = doc(db, "products", productId);
        await updateDoc(productRef, {
          ratings: arrayUnion({
            userId,
            rating: parseInt(rating),
            comment,
            timestamp: serverTimestamp()
          })
        });
        
        alert("شكراً لتقييمك المنتج!");
        closeModal("ratingModal");
        loadProducts();
      } catch (error) {
        alert("حدث خطأ أثناء إرسال التقييم: " + error.message);
      }
    }

    /* ---- وظائف العربة ---- */
    function renderCart() {
      const cartContainer = document.getElementById("cart-list");
      cartContainer.innerHTML = cart.length ? "" : "لا توجد منتجات في العربة.";
      cart.forEach((p, index) => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <h3>${p.name}</h3>
          <strong>${p.price} ريال</strong><br>
          <button onclick="removeFromCart(${index})" style="background:#dc3545">❌ حذف</button>
        `;
        cartContainer.appendChild(div);
      });
      updateCartBadge();
    }

    function updateCartBadge() {
      const badge = document.getElementById("cart-badge");
      if (badge) {
        badge.textContent = cart.length > 0 ? cart.length : "";
        badge.style.display = cart.length > 0 ? "inline-block" : "none";
      }
    }

    window.removeFromCart = function(index) {
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    };

    /* ---- إتمام الطلب ---- */
    async function checkout() {
      if (!auth.currentUser) {
        alert("يرجى تسجيل الدخول قبل تأكيد الطلب");
        openModal("loginModal");
        return;
      }
      if (!cart.length) return alert("عربة التسوق فارغة!");
      
      try {
        await addDoc(collection(db, "orders"), {
          userId: auth.currentUser.uid,
          items: cart,
          createdAt: serverTimestamp(),
          status: "قيد المعالجة"
        });
        alert("تم إرسال الطلب بنجاح!");
        cart = [];
        localStorage.removeItem("cart");
        renderCart();
        loadOrders();
      } catch (error) {
        alert("حدث خطأ أثناء إرسال الطلب: " + error.message);
      }
    }

    /* ---- تحميل الطلبات الخاصة بالمستخدم ---- */
    async function loadOrders() {
      const container = document.getElementById("order-list");
      container.innerHTML = "";
      if (!auth.currentUser) {
        container.innerHTML = "يرجى تسجيل الدخول لعرض سجل الطلبات.";
        return;
      }
      
      try {
        const querySnapshot = await getDocs(collection(db, "orders"));
        let found = false;
        querySnapshot.forEach(doc => {
          const order = doc.data();
          if (order.userId !== auth.currentUser.uid) return;
          found = true;
          const card = document.createElement("div");
          card.className = "product";
          const dateStr = order.createdAt ? order.createdAt.toDate().toLocaleString() : "تاريخ غير متوفر";
          card.innerHTML = `<h4>طلب بتاريخ: ${dateStr} (${order.status})</h4>`;
          order.items.forEach(p => {
            card.innerHTML += `<p>📦 ${p.name} - ${p.price} ريال</p>`;
          });
          container.appendChild(card);
        });
        if (!found) container.innerHTML = "لا يوجد طلبات لهذا المستخدم.";
      } catch (error) {
        container.innerHTML = "حدث خطأ أثناء تحميل الطلبات.";
        console.error("Error loading orders:", error);
      }
    }

    /* ---- تحميل المنتجات ---- */
    async function loadProducts() {
      const container = document.getElementById("product-list");
      container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>جاري تحميل المنتجات...</p></div>';
      
      try {
        const querySnapshot = await getDocs(collection(db, "products"));
        allProducts = [];
        querySnapshot.forEach(doc => {
          allProducts.push({ id: doc.id, ...doc.data() });
        });
        
        if (allProducts.length === 0) {
          container.innerHTML = '<div class="empty">لا توجد منتجات متاحة حالياً.</div>';
          return;
        }
        
        renderProducts(allProducts);
      } catch (error) {
        container.innerHTML = '<div class="error">حدث خطأ أثناء تحميل المنتجات.</div>';
        console.error("Error loading products:", error);
      }
    }

    /* ---- إضافة منتج للعربة ---- */
    window.addToCart = function(product) {
      if (!auth.currentUser) {
        alert("يرجى تسجيل الدخول لإضافة المنتج إلى العربة.");
        openModal("loginModal");
        return;
      }
      
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        if (confirm("هذا المنتج موجود بالفعل في العربة. هل تريد إضافة كمية أخرى؟")) {
          cart.push(product);
        }
      } else {
        cart.push(product);
      }
      
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      alert("تمت إضافة المنتج إلى العربة");
    };

    /* ---- تسجيل الدخول بالبريد ---- */
    window.loginUser = function(e) {
      e.preventDefault();
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;
      
      if (!email || !password) {
        alert("يرجى إدخال البريد الإلكتروني وكلمة المرور");
        return;
      }
      
      const btn = e.target.querySelector("button[type='submit']");
      const originalText = btn.textContent;
      btn.textContent = "جاري تسجيل الدخول...";
      btn.disabled = true;
      
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("تم تسجيل الدخول بنجاح");
          closeModal("loginModal");
          renderCart();
          loadOrders();
        })
        .catch(err => {
          let message = "حدث خطأ أثناء تسجيل الدخول";
          if (err.code === "auth/invalid-credential") {
            message = "البريد الإلكتروني أو كلمة المرور غير صحيحة";
          }
          alert(message);
        })
        .finally(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        });
    };

    /* ---- تسجيل الدخول بجوجل ---- */
    window.signInWithGoogle = function() {
      signInWithPopup(auth, googleProvider)
        .then(() => {
          alert("تم تسجيل الدخول بحساب Google");
          closeModal("loginModal");
          renderCart();
          loadOrders();
        })
        .catch(err => alert("خطأ: " + err.message));
    };

    /* ---- تسجيل الدخول بفيسبوك ---- */
    window.signInWithFacebook = function() {
      signInWithPopup(auth, facebookProvider)
        .then(() => {
          alert("تم تسجيل الدخول بحساب Facebook");
          closeModal("loginModal");
          renderCart();
          loadOrders();
        })
        .catch(err => {
          if (err.code === "auth/account-exists-with-different-credential") {
            alert("هذا البريد مرتبط بطريقة تسجيل مختلفة. جرّب تسجيل الدخول بالطريقة الأخرى.");
          } else {
            alert("خطأ: " + err.message);
          }
        });
    };

    /* ---- إنشاء حساب بالبريد ---- */
    window.registerUser = function(e) {
      e.preventDefault();
      const email = document.getElementById("register-email").value.trim();
      const password = document.getElementById("register-password").value;
      
      if (!email || !password) {
        alert("يرجى إدخال البريد الإلكتروني وكلمة المرور");
        return;
      }
      
      const btn = e.target.querySelector("button[type='submit']");
      const originalText = btn.textContent;
      btn.textContent = "جاري إنشاء الحساب...";
      btn.disabled = true;
      
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("تم إنشاء الحساب بنجاح");
          closeModal("registerModal");
        })
        .catch(err => alert("خطأ: " + err.message))
        .finally(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        });
    };

    /* ---- تسجيل الخروج ---- */
    window.logoutUser = function() {
      if (confirm("هل أنت متأكد من تسجيل الخروج؟")) {
        signOut(auth).then(() => {
          alert("تم تسجيل الخروج");
          renderCart();
          loadOrders();
        }).catch(err => alert("حدث خطأ أثناء تسجيل الخروج: " + err.message));
      }
    };

    /* ---- مراقبة حالة المستخدم ---- */
    onAuthStateChanged(auth, (user) => {
      const loginLink = document.getElementById("loginLink");
      const registerLink = document.getElementById("registerLink");
      const logoutLink = document.getElementById("logoutLink");
      if (user) {
        loginLink.style.display = "none";
        registerLink.style.display = "none";
        logoutLink.style.display = "inline-block";
      } else {
        loginLink.style.display = "inline-block";
        registerLink.style.display = "inline-block";
        logoutLink.style.display = "none";
      }
    });

    /* ---- تحميل أولي ---- */
    window.addEventListener("DOMContentLoaded", () => {
      renderCart();
      loadProducts();
      loadOrders();
    });
  </script>

  <!-- ---------- وظائف الواجهة العامة (مودالات، وضع ليلي) ---------- -->
  <script>
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    }
    
    function openModal(id) {
      document.getElementById(id).style.display = "flex";
      document.body.style.overflow = "hidden";
    }
    
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
      document.body.style.overflow = "auto";
    }
    
    window.onclick = function(e) {
      ["loginModal", "registerModal", "ratingModal"].forEach(id => {
        const m = document.getElementById(id);
        if (e.target === m) closeModal(id);
      });
    };
    
    // تحميل وضع الوضع الليلي من التخزين المحلي
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark-mode");
    }
  </script>
</body>
</html>